<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaronaApp</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#E1F000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root { --primary: #E1F000; --bg: #0a0a0a; --card: #1a1a1a; --text: #fff; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: var(--bg); color: var(--text); display: flex; justify-content: center; min-height: 100vh; }
        #app { width: 100%; max-width: 480px; padding: 20px; display: flex; flex-direction: column; }
        
        /* INPUTS E FONTES GRANDES PARA CELULAR */
        input, select, textarea { 
            width: 100%; padding: 15px; background: var(--card); border: 1px solid #333; 
            color: #fff; margin-bottom: 15px; border-radius: 8px; font-size: 18px; 
        }
        label { display:block; margin-bottom:8px; color:#aaa; font-size: 16px; margin-top: 5px; }

        /* BOT√ïES */
        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 12px; transition: 0.2s; font-size: 18px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-p { background: var(--primary); color: #000; }
        .btn-o { border: 2px solid var(--primary); color: var(--primary); background: transparent; }
        .btn-text { background: none; border: none; color: #fff; font-size: 20px; font-weight: bold; cursor: pointer; padding: 10px; }
        .btn-back { background: none; border: none; color: #aaa; font-size: 20px; cursor: pointer; padding: 10px 0; margin-bottom: 10px; text-align: left; display: block; width: 100%; }

        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--primary); }
        .screen { display: none; animation: fade 0.3s; } .active { display: block; } @keyframes fade {from{opacity:0}to{opacity:1}}
        
        .dir-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .dir-btn { flex: 1; padding: 15px; background: #333; text-align: center; border-radius: 8px; cursor: pointer; font-size: 18px; }
        .dir-btn.active { background: var(--primary); color: #000; font-weight: bold; }
        
        #notif { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: var(--primary); padding: 15px; border-radius: 30px; display: none; z-index: 999; text-align:center; border: 1px solid var(--primary); font-weight: bold; width: 90%; font-size: 16px; }
        
        /* MODAIS */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; align-items:flex-end; z-index:1000; }
        .modal-c { background:#222; width:100%; padding:25px; border-radius:20px 20px 0 0; }
        .pass-item { background: #111; padding: 12px; margin-top: 5px; border-radius: 5px; border-left: 2px solid #555; font-size: 16px; }

        /* ESTILOS DE ROTA E TRAJETO */
        .label-trajeto { color: #aaa; font-size: 12px; text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 4px; letter-spacing: 1px; }
        .texto-trajeto { margin: 0 0 10px 0; font-size: 20px; color: white; }
        .rota-list { list-style: none; padding: 0; margin: 10px 0; }
        .rota-item { color: #ddd; font-size: 15px; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .rota-time { color: var(--primary); font-weight: bold; background: #333; padding: 2px 6px; border-radius: 4px; font-size: 14px; }
    </style>
</head>
<body>
    <div id="notif"></div>

    <div id="m-aceite" class="modal">
        <div class="modal-c">
            <h3>Aceitar Carona?</h3>
            <p style="color:#aaa; margin-bottom:15px; font-size:16px;">Informe seus dados de contato.</p>
            
            <label>Seu Nome *</label>
            <input id="a-nome" placeholder="Ex: Ana Souza">
            
            <label>Seu WhatsApp/Celular *</label>
            <input id="a-tel" type="tel" placeholder="(11) 99999-9999">
            
            <label>Observa√ß√£o (Opcional)</label>
            <input id="a-obs" placeholder="Ex: Mala pequena">
            
            <button id="btn-conf-aceite" class="btn btn-p" onclick="confirmarAceite()">Confirmar Vaga</button>
            <button class="btn" onclick="fechar()" style="background:#333; color:#fff">Cancelar</button>
        </div>
    </div>

    <div id="m-cancel" class="modal">
        <div class="modal-c">
            <h3>Cancelar?</h3>
            <input id="c-motivo" placeholder="Motivo (Opcional)">
            <button id="btn-conf-cancel" class="btn btn-p" style="background:red; color:white" onclick="confirmarCancel()">Confirmar Cancelamento</button>
            <button class="btn" onclick="fechar()" style="background:#333; color:#fff">Voltar</button>
        </div>
    </div>

    <div id="app">
        <section id="s-login" class="screen active">
            <h1 style="text-align:center; margin:40px 0; color:var(--primary); font-size: 3rem;">CaronaApp</h1>
            
            <input id="l-email" placeholder="Usu√°rio (Ex: ThiagoMuniz)">
            <input type="password" id="l-pass" placeholder="Senha">
            
            <button id="btn-login" class="btn btn-p" onclick="login()">Entrar</button>
            
            <p style="text-align:center; color:#666; font-size:14px; margin-top:20px">
                Acesso restrito. Fale com o administrador.
            </p>
        </section>

        <section id="s-dash" class="screen">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="font-size: 1.5rem;">Ol√°, <span id="u-name" style="color:var(--primary)">...</span></h2>
                <button onclick="logout()" class="btn-text" style="color:#ff4d4d">Sair</button>
            </div>
            <button class="btn btn-o" onclick="nav('s-driver')" style="height:120px; font-size:1.4rem;">üöò Sou Motorista</button>
            <button class="btn btn-p" onclick="nav('s-pass')" style="height:120px; font-size:1.4rem;">üôã‚Äç‚ôÇÔ∏è Sou Passageiro</button>
        </section>

        <section id="s-driver" class="screen">
            <button onclick="nav('s-dash')" class="btn-back">‚Üê Voltar</button>
            <button class="btn btn-p" onclick="nav('s-new')">+ Nova Carona</button>
            <h3 style="margin-top:20px">Minhas Ofertas</h3>
            <div id="list-driver">Carregando...</div>
        </section>

        <section id="s-new" class="screen">
            <button onclick="nav('s-driver')" class="btn-back">‚Üê Voltar</button>
            <h2 style="margin-bottom:15px">Nova Carona</h2>
            <div class="dir-row">
                <div id="btn-ida" class="dir-btn active" onclick="setDir('ida')">IDA</div>
                <div id="btn-volta" class="dir-btn" onclick="setDir('volta')">VOLTA</div>
            </div>
            
            <label>Seu Nome (Motorista) *</label>
            <input id="n-nome" placeholder="Ex: Thiago Alves" required>

            <label>Seu WhatsApp/Celular *</label>
            <input id="n-tel" type="tel" placeholder="(11) 99999-9999" required>

            <label>Data *</label>
            <input type="date" id="n-data" required>
            
            <label>Origem *</label>
            <input id="n-origem" placeholder="De onde sai?">
            
            <label>Destino *</label>
            <input id="n-dest" placeholder="Para onde vai?" disabled value="F√°brica Jundia√≠">
            
            <h3 style="margin: 20px 0 10px 0; color:var(--primary); font-size:1.2rem;">Rota e Hor√°rios</h3>
            
            <div style="border:1px solid #333; padding:10px; border-radius:8px; margin-bottom:15px;">
                <label>Ponto 1 (Obrigat√≥rio) *</label><input id="n-p1" placeholder="Ex: Shopping">
                <label>Hor√°rio 1 *</label><input type="time" id="n-h1">
            </div>
            <div style="border:1px solid #333; padding:10px; border-radius:8px; margin-bottom:15px;">
                <label>Ponto 2 (Opcional)</label><input id="n-p2" placeholder="Ex: Rodovi√°ria">
                <label>Hor√°rio 2</label><input type="time" id="n-h2">
            </div>
            <div style="border:1px solid #333; padding:10px; border-radius:8px; margin-bottom:15px;">
                <label>Ponto 3 (Opcional)</label><input id="n-p3" placeholder="Ex: Posto">
                <label>Hor√°rio 3</label><input type="time" id="n-h3">
            </div>
            
            <label>Vagas Dispon√≠veis</label>
            <select id="n-vagas">
                <option value="1">1 Vaga</option>
                <option value="2">2 Vagas</option>
                <option value="3">3 Vagas</option>
                <option value="4">4 Vagas</option>
            </select>
            
            <button id="btn-publicar" class="btn btn-p" onclick="salvarCarona()">Publicar Carona</button>
        </section>

        <section id="s-pass" class="screen">
            <button onclick="nav('s-dash')" class="btn-back">‚Üê Voltar</button>
            <div class="dir-row">
                <div class="dir-btn active" onclick="verPass('busca')" id="t-busca">Buscar</div>
                <div class="dir-btn" onclick="verPass('minhas')" id="t-minhas">Minhas</div>
            </div>
            <div id="list-pass">Carregando...</div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, arrayUnion, increment, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CHAVES DO FIREBASE (Configura√ß√£o Manual e Segura) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCvszWzlqyo-s80VFOY3AVqUln8KMxJHDI",
            authDomain: "caronaapp-de78c.firebaseapp.com",
            projectId: "caronaapp-de78c",
            storageBucket: "caronaapp-de78c.firebasestorage.app",
            messagingSenderId: "199675445210",
            appId: "1:199675445210:web:b2cde43424ab7c46a70ae3",
            measurementId: "G-9Q1VPNLRZE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let user = null;
        let dir = 'ida';
        let tempId = null; let tempAction = null;

        // AUTH - LOGIN POR NOME (ADICIONA @carona.app AUTOMATICAMENTE)
        window.login = async () => {
            let userLogin = document.getElementById('l-email').value.trim();
            const p = document.getElementById('l-pass').value;
            const btn = document.getElementById('btn-login');
            
            if(!userLogin || !p) return alert("Preencha usu√°rio e senha");
            
            // TRUQUE: Adiciona o dom√≠nio se o usu√°rio n√£o digitar
            if (!userLogin.includes('@')) {
                userLogin = userLogin + "@carona.app";
            }
            
            btn.innerText = "Entrando..."; btn.disabled = true;

            try {
                await signInWithEmailAndPassword(auth, userLogin, p);
            } catch(err) { 
                console.error(err);
                let msg = "Erro desconhecido";
                if(err.code.includes('invalid') || err.code.includes('not-found')) msg = "Usu√°rio ou senha incorretos.";
                alert(msg); 
                btn.innerText = "Entrar"; btn.disabled = false;
            }
        };

        onAuthStateChanged(auth, u => {
            user = u;
            if(u) { 
                // Mostra apenas o nome antes do @
                document.getElementById('u-name').innerText = u.email.split('@')[0]; 
                nav('s-dash'); 
            } else {
                nav('s-login');
            }
        });

        window.logout = () => signOut(auth);

        // NAVEGA√á√ÉO
        window.nav = (s) => {
            document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active'));
            document.getElementById(s).classList.add('active');
            if(s==='s-driver') carregarDriver();
            if(s==='s-pass') verPass('busca');
        };

        // MOTORISTA: CONFIGURAR IDA/VOLTA
        window.setDir = (d) => {
            dir = d;
            document.getElementById('btn-ida').className = d==='ida'?'dir-btn active':'dir-btn';
            document.getElementById('btn-volta').className = d==='volta'?'dir-btn active':'dir-btn';
            const origem = document.getElementById('n-origem');
            const dest = document.getElementById('n-dest');
            if(d==='ida') {
                origem.value = ""; origem.disabled = false; origem.placeholder = "De onde sai?";
                dest.value = "F√°brica Jundia√≠"; dest.disabled = true;
            } else {
                origem.value = "F√°brica Jundia√≠"; origem.disabled = true;
                dest.value = ""; dest.disabled = false; dest.placeholder = "Para onde vai?";
            }
        };

        // SALVAR CARONA (COM PONTOS, HOR√ÅRIOS E TEL)
        window.salvarCarona = async () => {
            if(!user) return;
            const nomeMoto = document.getElementById('n-nome').value;
            const telMoto = document.getElementById('n-tel').value;
            const dataViagem = document.getElementById('n-data').value;
            const origem = document.getElementById('n-origem').value;
            const dest = document.getElementById('n-dest').value;
            
            const p1 = document.getElementById('n-p1').value;
            const h1 = document.getElementById('n-h1').value;
            
            const vagas = parseInt(document.getElementById('n-vagas').value) || 1;

            if(!nomeMoto) return alert("Digite seu nome.");
            if(!telMoto) return alert("Digite seu Telefone/WhatsApp.");
            if(!dataViagem) return alert("Data obrigat√≥ria.");
            if(!p1) return alert("Ponto 1 obrigat√≥rio.");
            if(!h1) return alert("Hor√°rio do Ponto 1 obrigat√≥rio.");
            if(dir === 'ida' && (!origem || origem.trim() === "")) return alert("Preencha a Origem.");
            if(dir === 'volta' && (!dest || dest.trim() === "")) return alert("Preencha o Destino.");

            const btn = document.getElementById('btn-publicar');
            btn.innerText = "Salvando..."; btn.disabled = true;

            try {
                await addDoc(collection(db, "caronas"), {
                    uid: user.uid, email: user.email, 
                    motorista: nomeMoto, tel: telMoto,
                    tipo: dir, data: dataViagem, origem: origem, dest: dest,
                    p1: p1, h1: h1,
                    p2: document.getElementById('n-p2').value, h2: document.getElementById('n-h2').value,
                    p3: document.getElementById('n-p3').value, h3: document.getElementById('n-h3').value,
                    vagas: vagas, pass: [], status: 'ativa', 
                    created: new Date().toISOString()
                });
                msg("Publicado! ‚úÖ");
                // Limpar campos
                document.getElementById('n-p1').value = ""; document.getElementById('n-h1').value = "";
                document.getElementById('n-p2').value = ""; document.getElementById('n-h2').value = "";
                document.getElementById('n-p3').value = ""; document.getElementById('n-h3').value = "";
                if(dir === 'ida') document.getElementById('n-origem').value = "";
                if(dir === 'volta') document.getElementById('n-dest').value = "";
                nav('s-driver'); 
            } catch(err) { alert("Erro ao salvar: " + err.message); } 
            finally { btn.innerText = "Publicar Carona"; btn.disabled = false; }
        };

        // FUN√á√ÉO DE BUSCA GERAL
        async function buscarTudo() {
            try {
                const snap = await getDocs(collection(db, "caronas"));
                const arr = [];
                snap.forEach(d => { const data = d.data(); data.id = d.id; arr.push(data); });
                return arr.sort((a,b) => b.created.localeCompare(a.created)); 
            } catch(err) { return []; }
        }

        // AUXILIAR: Monta a lista visual de Rota e Hor√°rios
        function montarRotaHTML(d) {
            let html = '<ul class="rota-list">';
            if(d.p1) html += `<li class="rota-item">üìç ${d.p1} <span class="rota-time">üïí ${d.h1}</span></li>`;
            if(d.p2) html += `<li class="rota-item">üìç ${d.p2} <span class="rota-time">üïí ${d.h2 || '--:--'}</span></li>`;
            if(d.p3) html += `<li class="rota-item">üìç ${d.p3} <span class="rota-time">üïí ${d.h3 || '--:--'}</span></li>`;
            html += '</ul>';
            return html;
        }

        // LISTA MOTORISTA (MINHAS OFERTAS)
        window.carregarDriver = async () => {
            const list = document.getElementById('list-driver');
            list.innerHTML = "Atualizando...";
            const all = await buscarTudo();
            list.innerHTML = "";
            const minhas = all.filter(d => d.uid === user.uid);
            if(minhas.length === 0) { list.innerHTML = "<p>Nenhuma oferta.</p>"; return; }
            minhas.forEach(d => {
                const color = d.status === 'cancelada' ? 'red' : '#E1F000';
                
                let listaPass = "";
                if(d.pass && d.pass.length > 0) {
                    listaPass = '<div style="background:#222; padding:10px; margin-top:10px; border-radius:8px"><small>Passageiros:</small>';
                    d.pass.forEach(p => {
                        listaPass += `<div class="pass-item">
                            üë§ <strong>${p.nome}</strong><br>
                            üìû ${p.tel || 'Sem tel'}<br>
                            <em style="color:#aaa; font-size:14px">${p.obs || 'Sem obs'}</em>
                        </div>`;
                    });
                    listaPass += '</div>';
                }

                list.innerHTML += `<div class="card" style="border-left-color:${color}">
                    <span class="label-trajeto">TRAJETO</span>
                    <h3 class="texto-trajeto">${d.origem} at√© ${d.dest}</h3>
                    <p>${fmtData(d.data)} ‚Ä¢ ${d.status.toUpperCase()}</p>
                    ${montarRotaHTML(d)}
                    <p style="font-size:18px">Vagas: ${d.vagas} Livres</p>
                    ${listaPass}
                    ${d.status !== 'cancelada' ? `<button class="btn" style="background:#333;color:red; margin-top:10px;" onclick="openCancel('${d.id}','motorista')">Cancelar Oferta</button>` : ''}
                </div>`;
            });
        };

        // LISTA PASSAGEIRO (BUSCAR / MINHAS)
        window.verPass = async (aba) => {
            document.getElementById('t-busca').className = aba==='busca'?'dir-btn active':'dir-btn';
            document.getElementById('t-minhas').className = aba==='minhas'?'dir-btn active':'dir-btn';
            const list = document.getElementById('list-pass');
            list.innerHTML = "Buscando...";
            const all = await buscarTudo();
            list.innerHTML = "";
            let count = 0;

            all.forEach(d => {
                const souMotorista = d.uid === user.uid;
                const souPassageiro = d.pass && d.pass.some(p => p.uid === user.uid);
                const telMotorista = d.tel || 'N√£o informado';

                if(aba === 'busca') {
                    if(!souMotorista && d.vagas > 0 && d.status !== 'cancelada' && !souPassageiro) {
                        count++;
                        const cor = d.tipo === 'ida' ? '#E1F000' : '#FF9100';
                        list.innerHTML += `<div class="card" style="border-left-color:${cor}">
                            <div style="display:flex; justify-content:space-between; align-items:start">
                                <span style="background:#333; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:bold">${d.tipo.toUpperCase()}</span>
                                <button class="btn btn-p" style="width:auto; padding:5px 15px; font-size:14px" onclick="openAceite('${d.id}')">ACEITAR</button>
                            </div>
                            <span class="label-trajeto" style="margin-top:10px;">TRAJETO</span>
                            <h3 class="texto-trajeto">${d.origem} at√© ${d.dest}</h3>
                            <p style="font-size:16px; margin-top:5px">Motorista: <strong>${d.motorista || 'An√¥nimo'}</strong></p>
                            <p>üìû ${telMotorista}</p>
                            ${montarRotaHTML(d)}
                            <p><strong>Vagas: ${d.vagas}</strong></p>
                        </div>`;
                    }
                } else {
                    if(souPassageiro) {
                        count++;
                        const isCancel = d.status === 'cancelada';
                        list.innerHTML += `<div class="card" style="border-left-color:${isCancel?'red':'#00e676'}">
                            <span class="label-trajeto">TRAJETO</span>
                            <h3 class="texto-trajeto">${d.origem} at√© ${d.dest}</h3>
                            <p>Motorista: <strong>${d.motorista || 'An√¥nimo'}</strong></p>
                            <p>üìû ${telMotorista}</p>
                            <p>${fmtData(d.data)} ‚Ä¢ ${isCancel?'CANCELADA':'CONFIRMADA'}</p>
                            ${montarRotaHTML(d)}
                            ${!isCancel?`<button class="btn" style="color:red; background:#222; margin-top:5px" onclick="openCancel('${d.id}','pass')">Cancelar Vaga</button>`:''}
                        </div>`;
                    }
                }
            });
            if(count === 0) list.innerHTML = "<p>Nada encontrado.</p>";
        };

        // A√á√ïES (ACEITAR / CANCELAR)
        window.openAceite = (id) => { tempId = id; document.getElementById('m-aceite').style.display = 'flex'; };
        window.openCancel = (id, type) => { tempId = id; tempAction = type; document.getElementById('m-cancel').style.display = 'flex'; };
        window.fechar = () => { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); };
        
        window.confirmarAceite = async () => {
            const btn = document.getElementById('btn-conf-aceite');
            const nomePass = document.getElementById('a-nome').value;
            const telPass = document.getElementById('a-tel').value;
            const obsPass = document.getElementById('a-obs').value;
            
            if(!nomePass) return alert("Digite seu nome.");
            if(!telPass) return alert("Digite seu WhatsApp.");
            
            btn.innerText = "..."; btn.disabled = true;
            try {
                await updateDoc(doc(db, "caronas", tempId), {
                    vagas: increment(-1),
                    pass: arrayUnion({ nome: nomePass, tel: telPass, obs: obsPass, uid: user.uid })
                });
                msg("Confirmado! ‚úÖ"); fechar(); verPass('busca');
            } catch(e) { alert("Erro: "+e.message); } finally { btn.innerText = "Confirmar Vaga"; btn.disabled = false; }
        };

        window.confirmarCancel = async () => {
            const btn = document.getElementById('btn-conf-cancel');
            btn.innerText = "..."; btn.disabled = true;
            try {
                const ref = doc(db, "caronas", tempId);
                if(tempAction === 'motorista') {
                    await updateDoc(ref, { status: 'cancelada', motivo: document.getElementById('c-motivo').value });
                    nav('s-driver');
                } else {
                    const docSnap = await getDoc(ref);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const novaLista = data.pass.filter(p => p.uid !== user.uid);
                        await updateDoc(ref, { pass: novaLista, vagas: increment(1) });
                        msg("Cancelado."); verPass('minhas');
                    }
                }
                fechar();
            } catch(e) { alert("Erro: "+e.message); } finally { btn.innerText = "Confirmar Cancelamento"; btn.disabled = false; }
        };

        function fmtData(d) { return d ? d.split('-').reverse().join('/') : '--/--'; }
        const msg = (t) => { const n=document.getElementById('notif'); n.innerText=t; n.style.display='block'; setTimeout(()=>n.style.display='none',3000); };
        if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>



