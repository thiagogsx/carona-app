<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaronaApp</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#E1F000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root { --primary: #E1F000; --bg: #0a0a0a; --card: #1a1a1a; --text: #fff; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: var(--bg); color: var(--text); display: flex; justify-content: center; min-height: 100vh; }
        #app { width: 100%; max-width: 480px; padding: 20px; display: flex; flex-direction: column; }
        input, select, textarea { width: 100%; padding: 15px; background: var(--card); border: 1px solid #333; color: #fff; margin-bottom: 10px; border-radius: 8px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: 0.2s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-p { background: var(--primary); color: #000; }
        .btn-o { border: 2px solid var(--primary); color: var(--primary); background: transparent; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--primary); }
        .screen { display: none; animation: fade 0.3s; } .active { display: block; } @keyframes fade {from{opacity:0}to{opacity:1}}
        .dir-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .dir-btn { flex: 1; padding: 10px; background: #333; text-align: center; border-radius: 8px; cursor: pointer; }
        .dir-btn.active { background: var(--primary); color: #000; }
        #notif { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: var(--primary); padding: 15px; border-radius: 30px; display: none; z-index: 999; text-align:center; border: 1px solid var(--primary); }
        /* Modais */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; align-items:flex-end; z-index:1000; }
        .modal-c { background:#222; width:100%; padding:20px; border-radius:20px 20px 0 0; }
    </style>
</head>
<body>
    <div id="notif"></div>

    <div id="m-aceite" class="modal"><div class="modal-c"><h3>Aceitar Carona?</h3><input id="a-nome" placeholder="Seu Nome"><button id="btn-conf-aceite" class="btn btn-p" onclick="confirmarAceite()">Confirmar</button><button class="btn" onclick="fechar()">Cancelar</button></div></div>
    <div id="m-cancel" class="modal"><div class="modal-c"><h3>Cancelar?</h3><input id="c-motivo" placeholder="Motivo do cancelamento"><button id="btn-conf-cancel" class="btn btn-p" style="background:red; color:white" onclick="confirmarCancel()">Confirmar</button><button class="btn" onclick="fechar()">Voltar</button></div></div>

    <div id="app">
        <section id="s-login" class="screen active">
            <h1 style="text-align:center; margin:40px 0; color:var(--primary)">CaronaApp</h1>
            <input id="l-email" placeholder="Email"><input type="password" id="l-pass" placeholder="Senha">
            <button id="btn-login" class="btn btn-p" onclick="login(true)">Entrar</button>
            <button id="btn-cad" class="btn btn-o" onclick="login(false)">Criar Conta</button>
        </section>

        <section id="s-dash" class="screen">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2>Ol√°, <span id="u-name" style="color:var(--primary)">...</span></h2>
                <button onclick="logout()" style="background:none; border:none; color:#fff;">Sair</button>
            </div>
            <button class="btn btn-o" onclick="nav('s-driver')" style="height:100px; font-size:1.2rem;">üöò Sou Motorista</button>
            <button class="btn btn-p" onclick="nav('s-pass')" style="height:100px; font-size:1.2rem;">üôã‚Äç‚ôÇÔ∏è Sou Passageiro</button>
        </section>

        <section id="s-driver" class="screen">
            <button onclick="nav('s-dash')" style="background:none; border:none; color:#aaa; margin-bottom:10px;">‚Üê Voltar</button>
            <button class="btn btn-p" onclick="nav('s-new')">+ Nova Carona</button>
            <h3>Minhas Ofertas</h3>
            <div id="list-driver">Carregando...</div>
        </section>

        <section id="s-new" class="screen">
            <button onclick="nav('s-driver')" style="background:none; border:none; color:#aaa; margin-bottom:10px;">‚Üê Voltar</button>
            <h2>Nova Carona</h2>
            <div class="dir-row">
                <div id="btn-ida" class="dir-btn active" onclick="setDir('ida')">IDA (F√°brica)</div>
                <div id="btn-volta" class="dir-btn" onclick="setDir('volta')">VOLTA (Casa)</div>
            </div>
            <label>Data</label><input type="date" id="n-data">
            <label>Origem</label><input id="n-origem" placeholder="Origem">
            <label>Destino</label><input id="n-dest" placeholder="Destino" disabled value="F√°brica Jundia√≠">
            <label>Pontos de Passagem</label>
            <input id="n-p1" placeholder="Ponto 1 (Obrigat√≥rio)">
            <input id="n-p2" placeholder="Ponto 2 (Opcional)">
            <label>Vagas</label>
            <select id="n-vagas"><option value="1">1 Vaga</option><option value="2">2 Vagas</option><option value="3">3 Vagas</option><option value="4">4 Vagas</option></select>
            <button id="btn-publicar" class="btn btn-p" onclick="salvarCarona()">Publicar</button>
        </section>

        <section id="s-pass" class="screen">
            <button onclick="nav('s-dash')" style="background:none; border:none; color:#aaa; margin-bottom:10px;">‚Üê Voltar</button>
            <div class="dir-row">
                <div class="dir-btn active" onclick="verPass('busca')" id="t-busca">Buscar</div>
                <div class="dir-btn" onclick="verPass('minhas')" id="t-minhas">Minhas</div>
            </div>
            <div id="list-pass">Carregando...</div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // SUAS CHAVES DO CARONAAPP (Verifique se est√£o certas)
        const firebaseConfig = {
            apiKey: "AIzaSyCvszWzlqyo-s80VFOY3AVqUln8KMxJHDI",
            authDomain: "caronaapp-de78c.firebaseapp.com",
            projectId: "caronaapp-de78c",
            storageBucket: "caronaapp-de78c.firebasestorage.app",
            messagingSenderId: "199675445210",
            appId: "1:199675445210:web:b2cde43424ab7c46a70ae3",
            measurementId: "G-9Q1VPNLRZE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let user = null;
        let dir = 'ida';
        let tempId = null; let tempAction = null;

        // AUTH
        window.login = async (isLogin) => {
            const e = document.getElementById('l-email').value;
            const p = document.getElementById('l-pass').value;
            const btn = isLogin ? document.getElementById('btn-login') : document.getElementById('btn-cad');
            const txt = btn.innerText;
            
            if(!e || !p) return msg("Preencha email e senha");
            btn.innerText = "..."; btn.disabled = true;

            try {
                if(isLogin) await signInWithEmailAndPassword(auth, e, p);
                else await createUserWithEmailAndPassword(auth, e, p);
            } catch(err) { 
                let m = err.code;
                if(err.code === 'auth/invalid-credential') m = "Senha errada ou usu√°rio n√£o existe";
                msg("Erro: " + m); 
            } finally {
                btn.innerText = txt; btn.disabled = false;
            }
        };

        onAuthStateChanged(auth, u => {
            user = u;
            if(u) { document.getElementById('u-name').innerText = u.email.split('@')[0]; nav('s-dash'); }
            else nav('s-login');
        });

        window.logout = () => signOut(auth);

        // MOTORISTA
        window.setDir = (d) => {
            dir = d;
            document.getElementById('btn-ida').className = d==='ida'?'dir-btn active':'dir-btn';
            document.getElementById('btn-volta').className = d==='volta'?'dir-btn active':'dir-btn';
            if(d==='ida') {
                document.getElementById('n-origem').value=""; document.getElementById('n-origem').disabled=false;
                document.getElementById('n-dest').value="F√°brica Jundia√≠"; document.getElementById('n-dest').disabled=true;
            } else {
                document.getElementById('n-origem').value="F√°brica Jundia√≠"; document.getElementById('n-origem').disabled=true;
                document.getElementById('n-dest').value=""; document.getElementById('n-dest').disabled=false;
            }
        };

        window.salvarCarona = async () => {
            if(!user) return;
            const btn = document.getElementById('btn-publicar');
            btn.innerText = "Salvando..."; btn.disabled = true;

            try {
                await addDoc(collection(db, "caronas"), {
                    uid: user.uid, 
                    email: user.email, 
                    tipo: dir,
                    data: document.getElementById('n-data').value,
                    origem: document.getElementById('n-origem').value,
                    dest: document.getElementById('n-dest').value,
                    p1: document.getElementById('n-p1').value,
                    p2: document.getElementById('n-p2').value,
                    vagas: parseInt(document.getElementById('n-vagas').value),
                    pass: [], 
                    status: 'ativa', 
                    created: new Date().toISOString()
                });
                msg("Carona Salva com Sucesso! ‚úÖ");
                document.getElementById('n-p1').value = ""; // Limpa campo
                nav('s-driver');
            } catch(err) {
                console.error(err);
                alert("ERRO CR√çTICO AO SALVAR:\n" + err.message + "\n\nVerifique se o dom√≠nio thiagogsx.github.io est√° autorizado no Firebase Authentication!");
            } finally {
                btn.innerText = "Publicar"; btn.disabled = false;
            }
        };

        // LISTAGEM GERAL (Carrega TUDO e filtra no JS para evitar bugs de √≠ndice)
        async function buscarTudo() {
            try {
                const snap = await getDocs(collection(db, "caronas"));
                const arr = [];
                snap.forEach(d => {
                    const data = d.data();
                    data.id = d.id;
                    arr.push(data);
                });
                return arr.sort((a,b) => b.created.localeCompare(a.created)); // Ordena mais recente
            } catch(err) {
                console.error(err);
                msg("Erro ao buscar dados. Verifique console.");
                return [];
            }
        }

        window.carregarDriver = async () => {
            const list = document.getElementById('list-driver');
            list.innerHTML = "Buscando...";
            const all = await buscarTudo();
            list.innerHTML = "";
            
            const minhas = all.filter(d => d.uid === user.uid);

            if(minhas.length === 0) { list.innerHTML = "<p>Nenhuma oferta criada por voc√™.</p>"; return; }

            minhas.forEach(d => {
                const color = d.status === 'cancelada' ? 'red' : '#E1F000';
                list.innerHTML += `<div class="card" style="border-left-color:${color}">
                    <h3>${d.origem} > ${d.dest}</h3>
                    <p>${fmtData(d.data)} ‚Ä¢ ${d.status.toUpperCase()}</p>
                    <p>Passageiros: ${d.pass ? d.pass.length : 0} / ${d.vagas + (d.pass ? d.pass.length : 0)}</p>
                    ${d.status !== 'cancelada' ? `<button class="btn" style="background:#333;color:red; margin-top:5px;" onclick="openCancel('${d.id}','motorista')">Cancelar Oferta</button>` : ''}
                </div>`;
            });
        };

        window.verPass = async (aba) => {
            document.getElementById('t-busca').className = aba==='busca'?'dir-btn active':'dir-btn';
            document.getElementById('t-minhas').className = aba==='minhas'?'dir-btn active':'dir-btn';
            
            const list = document.getElementById('list-pass');
            list.innerHTML = "Buscando...";
            const all = await buscarTudo();
            list.innerHTML = "";
            
            let count = 0;

            all.forEach(d => {
                const souMotorista = d.uid === user.uid;
                const souPassageiro = d.pass && d.pass.some(p => p.uid === user.uid);
                
                if(aba === 'busca') {
                    // Filtra: N√£o sou motorista, Tem Vaga, N√£o est√° cancelada
                    if(!souMotorista && d.vagas > 0 && d.status !== 'cancelada' && !souPassageiro) {
                        count++;
                        const cor = d.tipo === 'ida' ? '#E1F000' : '#FF9100';
                        list.innerHTML += `<div class="card" style="border-left-color:${cor}">
                            <div style="display:flex; justify-content:space-between">
                                <h3>${d.tipo.toUpperCase()}</h3>
                                <button class="btn btn-p" style="width:auto; padding:5px 15px;" onclick="openAceite('${d.id}')">ACEITAR</button>
                            </div>
                            <p style="color:white; font-size:1.1rem">${d.origem} > ${d.dest}</p>
                            <p>${fmtData(d.data)} ‚Ä¢ Vagas: ${d.vagas}</p>
                            <small>Passa em: ${d.p1}</small>
                        </div>`;
                    }
                } else {
                    // Minhas Reservas
                    if(souPassageiro) {
                        count++;
                        const isCancel = d.status === 'cancelada';
                        list.innerHTML += `<div class="card" style="border-left-color:${isCancel?'red':'#00e676'}">
                            <h3>${d.origem} > ${d.dest}</h3>
                            <p>${fmtData(d.data)} ‚Ä¢ ${isCancel?'CANCELADA P/ MOTORISTA':'CONFIRMADA'}</p>
                            ${!isCancel?`<button class="btn" style="color:red; background:#222; margin-top:5px" onclick="openCancel('${d.id}','pass')">Cancelar Vaga</button>`:''}
                        </div>`;
                    }
                }
            });

            if(count === 0) list.innerHTML = "<p>Nada encontrado.</p>";
        };

        // MODAL ACTIONS
        window.openAceite = (id) => { tempId = id; document.getElementById('m-aceite').style.display = 'flex'; };
        window.openCancel = (id, type) => { tempId = id; tempAction = type; document.getElementById('m-cancel').style.display = 'flex'; };
        window.fechar = () => { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); };
        
        window.confirmarAceite = async () => {
            const btn = document.getElementById('btn-conf-aceite');
            btn.innerText = "..."; btn.disabled = true;
            try {
                await updateDoc(doc(db, "caronas", tempId), {
                    vagas: increment(-1),
                    pass: arrayUnion({ nome: document.getElementById('a-nome').value, uid: user.uid })
                });
                msg("Aceito! ‚úÖ"); fechar(); verPass('busca');
            } catch(e) { alert("Erro: "+e.message); } finally { btn.innerText = "Confirmar"; btn.disabled = false; }
        };

        window.confirmarCancel = async () => {
            const btn = document.getElementById('btn-conf-cancel');
            btn.innerText = "..."; btn.disabled = true;
            try {
                const ref = doc(db, "caronas", tempId);
                if(tempAction === 'motorista') {
                    await updateDoc(ref, { status: 'cancelada', motivo: document.getElementById('c-motivo').value });
                    nav('s-driver');
                } else {
                    // Solu√ß√£o simplificada: Apenas devolve a vaga visualmente
                    await updateDoc(ref, { vagas: increment(1) }); 
                    msg("Cancelado"); verPass('minhas');
                }
                fechar();
            } catch(e) { alert("Erro: "+e.message); } finally { btn.innerText = "Confirmar"; btn.disabled = false; }
        };

        // UTILS
        function fmtData(d) { return d ? d.split('-').reverse().join('/') : '--/--'; }
        window.nav = (s) => {
            document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active'));
            document.getElementById(s).classList.add('active');
            if(s==='s-driver') carregarDriver();
            if(s==='s-pass') verPass('busca');
        };
        const msg = (t) => { const n=document.getElementById('notif'); n.innerText=t; n.style.display='block'; setTimeout(()=>n.style.display='none',3000); };
        
        if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>
